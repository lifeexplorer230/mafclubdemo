<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑ 1.1-1.3</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .phase {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .phase h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        .result {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #27ae60; font-weight: bold; }
        .error { color: #e74c3c; font-weight: bold; }
        .info { color: #3498db; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑ 1.1-1.3</h1>
    <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–∑—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>

    <!-- Dynamic Version -->
    <div class="phase">
        <h2>‚ú® Dynamic Version Loading</h2>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤–µ—Ä—Å–∏–∏ –∏–∑ API</p>
        <button onclick="testVersion()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –≤–µ—Ä—Å–∏–∏</button>
        <button onclick="testVersionDisplay()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏</button>
        <div id="version-result" class="result" style="display:none;"></div>
    </div>

    <!-- Input Validation -->
    <div class="phase">
        <h2>üõ°Ô∏è –§–∞–∑–∞ 1.3: Input Validation</h2>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Zod</p>
        <button onclick="testInvalidDate()">–¢–µ—Å—Ç: –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –¥–∞—Ç–∞</button>
        <button onclick="testInvalidRole()">–¢–µ—Å—Ç: –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è —Ä–æ–ª—å</button>
        <button onclick="testInvalidPlayerCount()">–¢–µ—Å—Ç: –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤</button>
        <button onclick="testValidData()">–¢–µ—Å—Ç: –í–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
        <div id="validation-result" class="result" style="display:none;"></div>
    </div>

    <!-- XSS Protection -->
    <div class="phase">
        <h2>üîí –§–∞–∑–∞ 1.1: XSS Protection</h2>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç XSS –∞—Ç–∞–∫</p>
        <button onclick="testXSS()">–¢–µ—Å—Ç: XSS –∞—Ç–∞–∫–∞</button>
        <button onclick="testSafeHTML()">–¢–µ—Å—Ç: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π HTML</button>
        <div id="xss-result" class="result" style="display:none;"></div>
        <div id="xss-demo" style="border: 1px solid #ddd; padding: 10px; margin-top: 10px; min-height: 50px;"></div>
    </div>

    <!-- CORS Protection -->
    <div class="phase">
        <h2>üåê –§–∞–∑–∞ 1.2: CORS Protection</h2>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ API</p>
        <button onclick="testCORS()">–¢–µ—Å—Ç: CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏</button>
        <button onclick="testSecurityHeaders()">–¢–µ—Å—Ç: Security Headers</button>
        <div id="cors-result" class="result" style="display:none;"></div>
    </div>

    <script>
        function showResult(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.innerHTML = `<span class="${type}">${message}</span>`;
        }

        // === Dynamic Version Tests ===
        async function testVersion() {
            try {
                const response = await fetch('/api/version');
                const data = await response.json();
                showResult('version-result',
                    `‚úÖ –£–°–ü–ï–•!\n\n–í–µ—Ä—Å–∏—è: ${data.version}\n–û–∫—Ä—É–∂–µ–Ω–∏–µ: ${data.environment}\nDeployment ID: ${data.deploymentId}\n–í—Ä–µ–º—è: ${data.timestamp}`,
                    'success'
                );
            } catch (error) {
                showResult('version-result', `‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
            }
        }

        function testVersionDisplay() {
            const versionElements = document.querySelectorAll('a[href*="rating.html"]');
            let found = false;
            versionElements.forEach(el => {
                if (el.textContent.match(/v\d+\.\d+\.\d+/)) {
                    found = true;
                    showResult('version-result',
                        `‚úÖ –í–µ—Ä—Å–∏—è –Ω–∞–π–¥–µ–Ω–∞: ${el.textContent}\n\n–≠–ª–µ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ version-loader.js`,
                        'success'
                    );
                }
            });
            if (!found) {
                showResult('version-result',
                    `‚è≥ –í–µ—Ä—Å–∏—è –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...\n\n–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`,
                    'info'
                );
            }
        }

        // === Input Validation Tests ===
        async function testInvalidDate() {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer egor_admin'
                    },
                    body: JSON.stringify({
                        date: 'invalid-date',
                        games: []
                    })
                });
                const data = await response.json();
                if (response.status === 400) {
                    showResult('validation-result',
                        `‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø –†–ê–ë–û–¢–ê–ï–¢!\n\nHTTP ${response.status}\n\n${JSON.stringify(data, null, 2)}`,
                        'success'
                    );
                } else {
                    showResult('validation-result',
                        `‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –¥–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞ (–æ–∂–∏–¥–∞–ª—Å—è 400)\n\n${JSON.stringify(data, null, 2)}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('validation-result', `‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
            }
        }

        async function testInvalidRole() {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer egor_admin'
                    },
                    body: JSON.stringify({
                        date: '2025-01-14',
                        games: [{
                            winner: '–ú–∏—Ä–Ω—ã–µ',
                            is_clean_win: false,
                            is_dry_win: false,
                            results: [
                                {player_id: 1, role: 'InvalidRole', death_time: null, additional_points: 0, achievements: []}
                            ]
                        }]
                    })
                });
                const data = await response.json();
                if (response.status === 400) {
                    showResult('validation-result',
                        `‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø –†–ê–ë–û–¢–ê–ï–¢!\n\nHTTP ${response.status}\n\n${JSON.stringify(data, null, 2)}`,
                        'success'
                    );
                } else {
                    showResult('validation-result',
                        `‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è —Ä–æ–ª—å –ø—Ä–∏–Ω—è—Ç–∞\n\n${JSON.stringify(data, null, 2)}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('validation-result', `‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
            }
        }

        async function testInvalidPlayerCount() {
            const results = [];
            for (let i = 1; i <= 9; i++) {
                results.push({
                    player_id: i,
                    role: i <= 7 ? '–ú–∏—Ä–Ω—ã–π' : '–ú–∞—Ñ–∏—è',
                    death_time: null,
                    additional_points: 0,
                    achievements: []
                });
            }

            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer egor_admin'
                    },
                    body: JSON.stringify({
                        date: '2025-01-14',
                        games: [{
                            winner: '–ú–∏—Ä–Ω—ã–µ',
                            is_clean_win: false,
                            is_dry_win: false,
                            results: results
                        }]
                    })
                });
                const data = await response.json();
                if (response.status === 400) {
                    showResult('validation-result',
                        `‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø –†–ê–ë–û–¢–ê–ï–¢!\n\n–û–∂–∏–¥–∞–µ—Ç—Å—è 10 –∏–≥—Ä–æ–∫–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 9\nHTTP ${response.status}\n\n${JSON.stringify(data, null, 2)}`,
                        'success'
                    );
                } else {
                    showResult('validation-result',
                        `‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ü—Ä–∏–Ω—è—Ç–æ 9 –∏–≥—Ä–æ–∫–æ–≤ –≤–º–µ—Å—Ç–æ 10\n\n${JSON.stringify(data, null, 2)}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('validation-result', `‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
            }
        }

        async function testValidData() {
            showResult('validation-result',
                `‚ÑπÔ∏è –¢–µ—Å—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î.\n\n–ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª—å–Ω—É—é —Ñ–æ—Ä–º—É game-input.html –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞.`,
                'info'
            );
        }

        // === XSS Tests ===
        function testXSS() {
            const demo = document.getElementById('xss-demo');
            const maliciousScript = '<script>alert("XSS Attack!")</script><img src=x onerror="alert(\'XSS\')">';

            // –ü–æ–ø—ã—Ç–∫–∞ –≤—Å—Ç–∞–≤–∏—Ç—å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π –∫–æ–¥
            demo.innerHTML = maliciousScript;

            setTimeout(() => {
                if (demo.querySelector('script')) {
                    showResult('xss-result',
                        `‚ùå –ü–†–û–ë–õ–ï–ú–ê: <script> —Ç–µ–≥–∏ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è!\n\n–í–Ω–µ–¥—Ä—ë–Ω –∫–æ–¥: ${maliciousScript}`,
                        'error'
                    );
                } else {
                    showResult('xss-result',
                        `‚úÖ –ó–ê–©–ò–¢–ê –†–ê–ë–û–¢–ê–ï–¢ (—á–∞—Å—Ç–∏—á–Ω–æ)!\n\n–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª <script> —Ç–µ–≥–∏, –Ω–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å escapeHtml() –∏–∑ dom-safe.js\n\n–ü–æ–ø—ã—Ç–∫–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è: ${maliciousScript}\n–†–µ–∑—É–ª—å—Ç–∞—Ç: ${demo.innerHTML}`,
                        'success'
                    );
                }
            }, 100);
        }

        function testSafeHTML() {
            showResult('xss-result',
                `‚ÑπÔ∏è Safe HTML —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ js/utils/dom-safe.js\n\n–§—É–Ω–∫—Ü–∏–∏:\n- escapeHtml(text): —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç HTML\n- createSafeElement(tag, props): —Å–æ–∑–¥–∞—ë—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç\n- setSafeText(element, text): —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ç–µ–∫—Å—Ç\n\n–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö: rating.html, player.html –∏ —Ç.–¥.`,
                'info'
            );
        }

        // === CORS Tests ===
        async function testCORS() {
            try {
                const response = await fetch('/api/rating');
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
                };

                if (corsHeaders['Access-Control-Allow-Origin'] === 'https://score.mafclub.biz') {
                    showResult('cors-result',
                        `‚úÖ CORS –ù–ê–°–¢–†–û–ï–ù –ü–†–ê–í–ò–õ–¨–ù–û!\n\n${JSON.stringify(corsHeaders, null, 2)}\n\n–¢–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã –º–æ–≥—É—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API.`,
                        'success'
                    );
                } else if (corsHeaders['Access-Control-Allow-Origin'] === '*') {
                    showResult('cors-result',
                        `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: CORS wildcard!\n\n${JSON.stringify(corsHeaders, null, 2)}\n\n–õ—é–±–æ–π –¥–æ–º–µ–Ω –º–æ–∂–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API.`,
                        'error'
                    );
                } else {
                    showResult('cors-result',
                        `‚ÑπÔ∏è CORS Headers:\n\n${JSON.stringify(corsHeaders, null, 2)}`,
                        'info'
                    );
                }
            } catch (error) {
                showResult('cors-result', `‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
            }
        }

        async function testSecurityHeaders() {
            try {
                const response = await fetch('/api/rating');
                const securityHeaders = {
                    'X-Frame-Options': response.headers.get('X-Frame-Options'),
                    'X-Content-Type-Options': response.headers.get('X-Content-Type-Options'),
                    'Referrer-Policy': response.headers.get('Referrer-Policy'),
                    'X-XSS-Protection': response.headers.get('X-XSS-Protection')
                };

                const allPresent = Object.values(securityHeaders).every(v => v !== null);

                if (allPresent) {
                    showResult('cors-result',
                        `‚úÖ –í–°–ï SECURITY HEADERS –£–°–¢–ê–ù–û–í–õ–ï–ù–´!\n\n${JSON.stringify(securityHeaders, null, 2)}`,
                        'success'
                    );
                } else {
                    showResult('cors-result',
                        `‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ headers –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:\n\n${JSON.stringify(securityHeaders, null, 2)}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('cors-result', `‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
            }
        }

        // Auto-test version on page load
        window.addEventListener('load', () => {
            setTimeout(testVersionDisplay, 2000);
        });
    </script>

    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏ -->
    <script src="/shared/version-loader.js"></script>
</body>
</html>
